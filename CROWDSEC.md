# CrowdSec Implementation & Security Handling

## 1. Overview
This stack utilizes **CrowdSec** as a collaborative Intrusion Prevention System (IPS). It acts as a middleware security layer, analyzing application logs (Traefik) to detect anomalous behavior and blocking malicious IPs at the application or firewall level.

The configuration included in this template focuses on:
*   **Layer 7 Protection:** Detecting HTTP flooding, scanning, and probing.
*   **Reputation Management:** Leveraging the CrowdSec central API to block known bad actors automatically.
*   **Compliance:** Providing audit-ready logs of blocked attempts.

## 2. Configuration Details

### 2.1 Log Acquisition
The CrowdSec agent reads logs directly from the mounted Traefik log volume. Configuration is located in `./crowdsec/acquis.yaml` generated by `init.sh`.

filenames:

/var/log/traefik/access.log
labels:
type: traefik

### 2.2 Collections
The following collections are pre-configured in the `docker-compose.yml` environment variables:
*   `crowdsecurity/traefik`: Parsers and scenarios specific to Traefik access logs.
*   `crowdsecurity/http-cve`: Detection of common CVE exploitation attempts (e.g., Log4Shell, Spring4Shell).

## 3. Administrative Operations

### Accessing the CLI
To interact with the CrowdSec agent (CSCLI), execute commands inside the running container.

**List active decisions (bans):**
docker exec crowdsec_ips cscli decisions list

**Manually ban an IP (e.g., for testing):**
docker exec crowdsec_ips cscli decisions add --ip 192.0.2.1 --reason "Manual compliance block"

**Unban an IP:**
docker exec crowdsec_ips cscli decisions delete --ip 192.0.2.1

**Update Hub (Parsers/Scenarios):**
docker exec crowdsec_ips cscli hub update
docker exec crowdsec_ips cscli hub upgrade

## 4. Remediation (Bouncers)
This template configures the **Detection Engine** only. To actively drop traffic, you must deploy a "Bouncer".

**Recommended for Docker Environments:**
For a self-contained setup, the [Traefik Bouncer](https://hub.docker.com/r/fbonalair/traefik-crowdsec-bouncer) middleware is recommended. Alternatively, a Firewall Bouncer can be installed on the host system (Linux) to drop packets at the iptables/nftables level for higher performance.

## 5. Maintenance & Updates
*   **Log Rotation:** Ensure the host system rotates `/logs/traefik/access.log` to prevent disk exhaustion. CrowdSec handles rotated logs automatically if configured correctly.
*   **Metrics:** Prometheus metrics are exposed on port `6060` inside the container if enabled in `config.yaml` for monitoring integration.

## 6. Troubleshooting
If legitimate traffic is being blocked:
1.  Check alerts: `docker exec crowdsec_ips cscli alerts list`
2.  Inspect specific alert details: `docker exec crowdsec_ips cscli alerts inspect <ID>`
3.  Add a whitelist in `/etc/crowdsec/parsers/s02-enrich/whitelist.yaml` (map volume required).
